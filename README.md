# rotify-Comments
با توجه به فایل‌هایی که ارائه دادی، بیایم یه فایل `README.md` جامع و مرتب برای افزونه `Rotify-Comments` بنویسیم که کاربرد هر فایل و کدهای داخلش رو توضیح بده. این فایل به‌عنوان مستندات پروژه می‌تونه توی گیت‌هاب یا ریشه پروژه استفاده بشه.

---

# Rotify-Comments - افزونه پرسش و پاسخ و نظرات وردپرس

**Rotify-Comments** یک افزونه وردپرسی است که به کاربران امکان می‌دهد پرسش‌ها و نظرات خود را در صفحات مختلف (مثلاً صفحات محصولات ووکامرس) ثبت کنند و مدیران سایت بتوانند این پرسش‌ها و نظرات را مدیریت کرده و به آن‌ها پاسخ دهند. این افزونه از شورت‌کدها برای نمایش فرم‌ها و محتوا استفاده می‌کند و قابلیت‌هایی مثل نیاز به ورود برای پرسش‌ها، نیاز به خرید محصول برای ثبت نظرات، و نمایش پاسخ‌های کارشناسان را فراهم می‌کند.

## ساختار پروژه

این پروژه شامل فایل‌های زیر است که هر کدام نقش خاصی در عملکرد افزونه دارند:

### 1. `rotify-comments.php`
- **کاربرد:** فایل اصلی افزونه که نقطه ورود آن است و مسئول فعال‌سازی و بارگذاری سایر فایل‌ها و منابع افزونه است.
- **جزئیات:**
  - تعریف اطلاعات افزونه (نام، توضیحات، نسخه، نویسنده و لینک نویسنده).
  - لود فایل‌های دیگر از پوشه `includes` شامل:
    - `post-types.php` (برای ثبت پست‌تایپ‌ها)
    - `settings.php` (برای مدیریت تنظیمات)
    - `forms.php` (برای فرم‌ها)
    - `displays.php` (برای نمایش پرسش‌ها و نظرات)
    - `admin.php` (برای مدیریت پنل ادمین)
  - لود استایل‌های افزونه (`style.css`) از پوشه `assets` با استفاده از هوک `wp_enqueue_scripts` برای فرانت‌اند و `admin_enqueue_scripts` برای بک‌اند.
- **نکات فنی:**
  - از تابع `plugin_dir_path()` و `plugin_dir_url()` برای دسترسی به مسیرها و URL‌های افزونه استفاده می‌کند.
  - از هوک‌های وردپرس برای لود منابع استفاده می‌کند.

### 2. `includes/post-types.php`
- **کاربرد:** این فایل مسئول ثبت پست‌تایپ‌های سفارشی و تنظیم منوهای مدیریتی در پیشخوان وردپرس است.
- **جزئیات:**
  - **پست‌تایپ `rotify_qa`:** برای ذخیره پرسش‌های کاربران.
    - تنظیمات: غیرعمومی (`public => false`)، قابل نمایش در پیشخوان (`show_ui => true`)، با آیکون `dashicons-admin-comments`.
    - پشتیبانی از عنوان و محتوا (`supports => array('title', 'editor')`).
  - **پست‌تایپ `rotify_comment`:** برای ذخیره نظرات کاربران.
    - تنظیمات مشابه `rotify_qa`، اما به‌عنوان زیرمنوی `rotify_qa` در پیشخوان نمایش داده می‌شود.
  - **تنظیم منوها:**
    - حذف زیرمنوهای پیش‌فرض وردپرس (مثل "افزودن جدید") برای جلوگیری از شلوغی.
    - اضافه کردن زیرمنوهای سفارشی: "پرسش‌ها"، "نظرات" و "تنظیمات".
  - **نمایش تعداد موارد در انتظار:**
    - تعداد پرسش‌ها و نظرات در انتظار تأیید را در منوی پیشخوان نمایش می‌دهد (با استفاده از `wp_count_posts`).
- **نکات فنی:**
  - از هوک `init` برای ثبت پست‌تایپ‌ها و هوک `admin_menu` برای تنظیم منوها استفاده می‌کند.
  - از تابع `remove_submenu_page` و `add_submenu_page` برای مدیریت منوها استفاده می‌کند.

### 3. `includes/displays.php`
- **کاربرد:** این فایل مسئول نمایش پرسش‌ها و نظرات تأییدشده در فرانت‌اند سایت است.
- **جزئیات:**
  - **شورت‌کد `[rotify_qa_display]`:**
    - پرسش‌های تأییدشده (`post_status => publish`) از پست‌تایپ `rotify_qa` را نمایش می‌دهد.
    - نام کاربر (یا "ناشناس" در صورت انتخاب گزینه ناشناس) و محتوای پرسش را نشان می‌دهد.
    - در صورت وجود پاسخ کارشناس (ذخیره‌شده در متادیتا `_wp_editor_answer`)، آن را نمایش می‌دهد.
    - قابلیت نمایش تصویر کاربر و کارشناس (از تنظیمات افزونه) را دارد.
  - **شورت‌کد `[rotify_comment_display]`:**
    - نظرات تأییدشده (`post_status => publish`) از پست‌تایپ `rotify_comment` را نمایش می‌دهد.
    - نام و نام خانوادگی، محتوای نظر، و امتیاز (به‌صورت ستاره) را نشان می‌دهد.
    - در صورت وجود پاسخ کارشناس، آن را نمایش می‌دهد.
    - قابلیت نمایش تصویر کاربر و کارشناس را دارد.
- **نکات فنی:**
  - از `WP_Query` برای دریافت پست‌ها استفاده می‌کند.
  - از `ob_start()` و `ob_get_clean()` برای مدیریت خروجی شورت‌کدها استفاده می‌کند.
  - از تابع `wp_reset_postdata()` برای جلوگیری از تداخل با حلقه‌های دیگر وردپرس استفاده می‌کند.

### 4. `includes/forms.php`
- **کاربرد:** این فایل مسئول تعریف و پردازش فرم‌های پرسش و نظرات است.
- **جزئیات:**
  - **شورت‌کد `[rotify_qa_form]`:**
    - یک فرم پرسش و پاسخ ایجاد می‌کند که کاربران می‌توانند سوالات خود را ثبت کنند.
    - قابلیت تنظیم نیاز به ورود کاربر (`require_login`) برای ارسال پرسش را دارد.
    - اطلاعات ارسالی (مثل متن سوال، شماره تماس، و نحوه نمایش نام کاربر) به‌صورت یک پست‌تایپ سفارشی (`rotify_qa`) با وضعیت `pending` ذخیره می‌شود.
    - از `nonce` برای امنیت فرم استفاده می‌کند.
  - **شورت‌کد `[rotify_comment_form]`:**
    - یک فرم نظرات برای صفحات محصولات ووکامرس ایجاد می‌کند.
    - قابلیت تنظیم نیاز به خرید محصول (`require_purchase`) برای ارسال نظر را دارد.
    - کاربران می‌توانند نام، امتیاز (ستاره‌ای) و متن نظر خود را وارد کنند.
    - نظرات به‌صورت یک پست‌تایپ سفارشی (`rotify_comment`) با وضعیت `pending` ذخیره می‌شوند.
    - برای بررسی خرید محصول، از تابع `wc_customer_bought_product` ووکامرس استفاده می‌کند.
    - از `nonce` برای امنیت فرم استفاده می‌کند.
- **نکات فنی:**
  - از `ob_start()` و `ob_get_clean()` برای مدیریت خروجی شورت‌کدها استفاده می‌کند.
  - داده‌های ورودی با توابعی مثل `sanitize_textarea_field` و `sanitize_text_field` ایمن‌سازی می‌شوند.

### 5. `includes/admin.php`
- **کاربرد:** این فایل مسئول مدیریت بخش‌های مدیریتی افزونه در پیشخوان وردپرس است.
- **جزئیات:**
  - **متاباکس‌ها:**
    - برای پست‌تایپ‌های `rotify_qa` و `rotify_comment` یک متاباکس با عنوان "جزئیات" اضافه می‌کند.
    - در `rotify_qa`: نمایش و ویرایش شماره تماس، نوع ارسال (ناشناس یا با نام کاربری)، و لینک صفحه مرتبط.
    - در `rotify_comment`: نمایش و ویرایش نام و نام خانوادگی، امتیاز، و لینک محصول.
  - **ذخیره متادیتا:**
    - متادیتاهای فرم‌ها (مثل شماره تماس، نام و نام خانوادگی، و امتیاز) را هنگام ذخیره پست ذخیره می‌کند.
  - **ستون‌های مدیریتی:**
    - ستون‌های سفارشی (عنوان، محتوا، پاسخ، وضعیت، و عملیات) را به جداول مدیریتی پست‌تایپ‌ها اضافه می‌کند.
    - امکان پاسخ‌دادن یا حذف پرسش‌ها و نظرات از طریق ستون "عملیات".
  - **ویرایشگر پاسخ:**
    - یک ویرایشگر متنی (با استفاده از `wp_editor`) برای پاسخ‌دادن به پرسش‌ها و نظرات در صفحه ویرایش پست اضافه می‌کند.
    - پاسخ‌ها در متادیتا `_rotify_answer` ذخیره می‌شوند.
- **نکات فنی:**
  - از هوک‌های `add_meta_boxes`، `save_post`، و `manage_posts_custom_column` برای مدیریت بخش‌های مدیریتی استفاده می‌کند.
  - داده‌ها با توابعی مثل `esc_attr` و `wp_kses_post` ایمن‌سازی می‌شوند.

### 6. `includes/settings.php`
- **کاربرد:** این فایل مسئول مدیریت صفحه تنظیمات افزونه در پیشخوان وردپرس است.
- **جزئیات:**
  - **صفحه تنظیمات:**
    - یک فرم تنظیمات با گزینه‌های زیر ایجاد می‌کند:
      - نیاز به خرید محصول برای نظرات (`rotify_require_purchase`)
      - نیاز به ورود برای پرسش‌ها (`rotify_require_login_qa`)
      - تصویر کاربر (`rotify_user_image`)
      - تصویر کارشناس (`rotify_expert_image`)
    - امکان آپلود تصویر با استفاده از رسانه وردپرس (Media Uploader) را فراهم می‌کند.
  - **ذخیره تنظیمات:**
    - تنظیمات را با استفاده از `update_option` ذخیره می‌کند.
    - از `nonce` برای امنیت فرم استفاده می‌کند.
  - **مستندات شورت‌کدها:**
    - در انتهای صفحه تنظیمات، شورت‌کدهای افزونه را برای کاربران نمایش می‌دهد:
      - `[rotify_qa_form]`: برای نمایش فرم ارسال پرسش
      - `[rotify_qa_display]`: برای نمایش پرسش‌ها و پاسخ‌ها
      - `[rotify_comment_form]`: برای نمایش فرم ارسال نظر
      - `[rotify_comment_display]`: برای نمایش نظرات
- **نکات فنی:**
  - از هوک `admin_init` برای ثبت تنظیمات و جاوااسکریپت برای مدیریت آپلود تصویر استفاده می‌کند.
  - داده‌ها با توابعی مثل `sanitize_text_field` ایمن‌سازی می‌شوند.

### 7. `assets/style.css`
- **کاربرد:** این فایل شامل استایل‌های CSS برای فرم‌ها، پیام‌ها، و بخش‌های نمایش افزونه است.
- **جزئیات:**
  - استایل‌دهی به فرم‌های پرسش و نظرات (کلاس‌هایی مثل `rotify-qa-form` و `rotify-comment-form`).
  - استایل‌دهی به پیام‌های خطا و موفقیت (کلاس‌هایی مثل `rotify-error` و `rotify-success`).
  - استایل‌دهی به سیستم امتیازدهی ستاره‌ای (کلاس `rotify-star-rating`).
  - استایل‌دهی به بخش‌های نمایش پرسش‌ها و نظرات (کلاس‌هایی مثل `rotify-qa-display` و `rotify-comment-display`).
  - استایل‌دهی به بخش‌های مدیریتی (مثل متاباکس‌ها و ستون‌ها).
- **نکات فنی:**
  - این فایل توسط تابع `rotify_enqueue_styles` در فایل `rotify-comments.php` لود می‌شود.

## نصب و راه‌اندازی

1. **نصب افزونه:**
   - پوشه افزونه (`rotify-comments`) را در مسیر `/wp-content/plugins/` آپلود کنید.
   - از بخش افزونه‌های وردپرس، افزونه Rotify-Comments را فعال کنید.

2. **تنظیمات:**
   - به منوی "پرسش و نظرات > تنظیمات" در پیشخوان وردپرس بروید.
   - گزینه‌های زیر را تنظیم کنید:
     - **نیاز به خرید محصول برای نظرات:** اگر فعال باشد، کاربران برای ارسال نظر باید محصول را خریداری کرده باشند.
     - **نیاز به ورود برای پرسش‌ها:** اگر فعال باشد، کاربران برای ارسال پرسش باید وارد شوند.
     - **تصویر کاربر و کارشناس:** تصاویر دلخواه برای نمایش کنار پرسش‌ها و پاسخ‌ها آپلود کنید.

3. **استفاده از شورت‌کدها:**
   - در صفحات یا محصولات ووکامرس، از شورت‌کدهای زیر استفاده کنید:
     - `[rotify_qa_form]`: برای نمایش فرم ارسال پرسش.
     - `[rotify_qa_display]`: برای نمایش پرسش‌ها و پاسخ‌ها.
     - `[rotify_comment_form]`: برای نمایش فرم ارسال نظر (فقط در صفحات محصولات ووکامرس کار می‌کند).
     - `[rotify_comment_display]`: برای نمایش نظرات تأییدشده.

## پیش‌نیازها
- وردپرس نسخه 5.0 یا بالاتر
- ووکامرس نسخه 3.0 یا بالاتر (برای فرم نظرات)
- المنتور (اختیاری، برای استفاده از شورت‌کدها در صفحات طراحی‌شده با المنتور)

## نکات مهم
- **دسترسی‌پذیری:** فرم‌ها با استانداردهای دسترسی‌پذیری طراحی شده‌اند، اما برای بهبود بیشتر، می‌توانید `id` و `autocomplete` به فیلدها اضافه کنید.
- **امنیت:** از `nonce` برای جلوگیری از حملات CSRF در فرم‌ها و تنظیمات استفاده شده است.
- **سازگاری:** این افزونه با المنتور و ووکامرس سازگار است، اما ممکن است با برخی افزونه‌های بهینه‌سازی (مثل WP Rocket) تداخل داشته باشد. در این صورت، کش افزونه را غیرفعال کنید.

## عیب‌یابی
- **چیدمان صفحه به هم می‌ریزد:**
  - مطمئن شوید فایل `style.css` به درستی لود می‌شود (خطای `net::ERR_CONNECTION_RESET` را بررسی کنید).
  - DOCTYPE صفحه را به `<!DOCTYPE html>` تنظیم کنید تا از Quirks Mode جلوگیری شود.
  - افزونه‌های بهینه‌سازی (مثل Autoptimize) را غیرفعال کنید و کش را پاک کنید.
- **فرم‌ها نمایش داده نمی‌شوند:**
  - بررسی کنید که آیا کاربر وارد شده است (برای فرم پرسش) یا محصول را خریداری کرده است (برای فرم نظرات).
  - خطاهای کنسول مرورگر (F12 > Console) را بررسی کنید.
- **پاسخ‌ها نمایش داده نمی‌شوند:**
  - مطمئن شوید که پرسش یا نظر تأیید شده است (`post_status => publish`).

## توسعه‌دهندگان
- **افزودن قابلیت جدید:** برای افزودن قابلیت‌های جدید، می‌توانید توابع موجود در فایل‌های `forms.php` و `displays.php` را گسترش دهید یا شورت‌کدهای جدیدی تعریف کنید.
- **استایل‌دهی:** استایل‌های سفارشی خود را به `assets/style.css` اضافه کنید.
- **مدیریت پیشرفته:** برای افزودن قابلیت‌های مدیریتی، می‌توانید متاباکس‌ها و ستون‌های جدید در `admin.php` تعریف کنید.

## لایسنس
این افزونه تحت لایسنس [GPLv2 یا بالاتر](https://www.gnu.org/licenses/gpl-2.0.html) منتشر شده است.

---

### توضیحات تکمیلی:
- این فایل `README.md` شامل توضیحات کامل و ساختارمند برای همه فایل‌های پروژه‌ست.
- اگه نیاز به تغییر یا اضافه کردن بخش خاصی داری (مثلاً توضیحات بیشتر درباره استایل‌ها یا یه بخش جدید برای توسعه‌دهندگان)، بگو تا اضافه کنم.
- این فایل رو می‌تونی توی ریشه پروژه‌ت ذخیره کنی و برای مستندات پروژه استفاده کنی.
